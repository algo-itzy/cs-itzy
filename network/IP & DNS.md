## IP & DNS

### IP

- Internet Protocol address
- 인터넷에 접속할 때 접속자에 대한 최소한의 정보가 공개되는 **인터넷 신분증**



### DNS

- Domain Name System
- 숫자로 구성된 네트워크 주소인 IP주소를 사람이 이해하기 쉬운 명칭인 도메인 이름으로 매칭해주는 시스템

#### 구조

![img](https://media.vlpt.us/images/cmin95/post/b3fb2909-67c2-4ddf-a3af-52b00832aa2e/2316A93F51C462940C.gif)



- 최상위 : .(Root), 인터넷도메인의 시작점
- 다음 단계 : 최상위도메인(TLD, Top Level Domain)
- 하위 단계로 여러 도메인 존재

#### 원리

![img](https://media.vlpt.us/images/cmin95/post/f591bf5b-a368-4565-8ab1-7dbe8b71dc24/Netmanias.2011.12.12-DNS_Basic.gif)

1. 웹 브라우저에 `www.naver.com`을 입력하면, 단말에 미리 설정되어 있는 Local DNS에게 `www.naver.com이라는 hostname`에 대한 IP 주소를 요청. 이 때 이에 대한 데이터가 존재한다면 IP주소를 제공
2. 관련된 데이터가 없다면 다른 DNS 서버들과 통신을 시작하고, 제일 먼저 Root DNS 서버에 위 주소에 대한 정보를 요청. Root DNS는 DNS의 루트 존으로, 전 세계에 13대만 구축되어 있는 서버이다. (우리나라는 미러서버를 운영)
3. Root DNS 서버는 Local DNS 서버에게 다른 DNS 서버(TLD, 여기서는 com DNS)에게 관련된 데이터를 요청하도록 유도, 응답
4. Local DNS는 TLD(com DNS)에 데이터를 요청
5. TLD는 다시 Local DNS에게 또 다른 DNS 서버(`naver.com DNS`)에게 관련된 데이터를 요청하도록 응답
6. Local DNS는 마지막으로 `naver.com`을 관리하는 DNS서버에 hostname에 대한 IP 주소를 요청
7. `naver.com DNS`는 Local DNS에게 IP주소 "222.122.195.6" 응답
8. Local DNS는 빠른 응답을 위해 `www.naver.com`에 대한 IP주소를 캐싱하고, 그 정보를 단말(PC)에 전달



### DNS Round Robin

- 별도의 SW,HW 로드벨런싱 장비 없이 오직 DNS만을 이용하여 도메인 레코드 정보를 조회하는 시점에서 트래픽을 분산하는 기법

  - 로드밸런싱

    ![img](https://blog.kakaocdn.net/dn/yY2sc/btq4VBpjmAM/kSvBRPxrUUwGKVObTd08k1/img.png)

    - 여러대의 서버를 준비하여 들어오는 트래픽을 여러 서버로 분산

- 웹 뿐만 아니라, 도메인을 사용하는 모든 서비스(FTP,SMTP 등)에 사용 가능

#### 원리

- 웹 서비스를 담당할 여러 대의 웹 서버는 자신의 공인 IP를 가지고 있음
- 사이트 접속을 위해 사용자가 해당 도메인 주소를 브라우저에 입력하면 DNS는 도메인의 정보를 조회
  - IP주소를 여러 대의 서버 IP리스트 중에서 라운드 로빈 형태로 랜덤하게 하나 혹은 여러개를 선택하여 사용자에게 알려준다.
- 실제로는 복수의 웹 서버에 나뉘어 접속하여 자연스럽게 서버의 부하가 분산

**라운드 로빈 DNS는 여러개의 IP주소를 결과로 돌려준다.**

- 사용자의 OS 애플리케이션에 따라 동작이 다르다.
  - 여러개의 IP 중 제일먼저 조회된 IP를 선택, 무작위로 IP를 선택한다.
  - 또는 선택 IP 접속이 안되면 그다음 조회된 IP접속하도록 호직을 추가할 수 있다.

 

#### 단점

- 지리적으로 복수의 웹서버가 멀리 떨어져 있어 실시간 헬스 체크가 어렵다.
  - 서버가 문제가 생겨 서비스가 불가한 상태라도 DNS는 이를 인지 못하고 도메인 조회 결과에 포함시킨다.
  - 그래서 HA(High- Abaliability)용도로 적합하지 못한다.
- DNS 조회 정보의 캐싱
  - 모바일 사이트 등에서 문제가 발생한다.
    - 스마트폰의 접속은 캐리어 게이트웨이 라고 하는 프록시 서버를 경유한다.
    - 프록시 서버에서는 이름변환 결과가 일정 시간 동안 캐싱되므로 같은 프록시 서버를 경유 하는 접속은 항상 같은 서버로 접속된다.
    - PC용 웹 브라우저도 DNS 질의 결과를 캐싱하기 때문에 균등하게 부하 분산되지 않는다.
    - DNS 레코드의 Time To Live(TTL)값을 짧게 설정함으로써 어느 정도 해소가 되지만 TTL에 따라 캐시를 해제하는 것은 아니므로 반드시 주의가 필요하다.
      - 웹 페이지, 스트림 된 영상, 데이터베이스 쿼리 결과만 캐싱 하는 것이 아닌, DNS가 조회한 도메인의 IP 정보도 네트워크 상에서 캐싱한다는 것❗❗
    - 도메인 설정 작업을 할때에는 캐싱 주기 설정을 고민해야 한다.
      - 캐싱을 무조건 길게 하면 관리자가 급하게 DNS 정보를 바꿔도 인터넷상에서 적용되려면 해당 시간 이상으로 기다려야 한다.
      - 바뀐 DNS 정보가 인터넷상의 네임 서버에 전파 되는 데 오랜 시간이 걸리기 때문이다.
      - 반배로 캐싱 주기를 짧게 하면 빠른 업데이트 반영은 가능하지만, 도메인 조회가빈번해지면서 사용자가 웹 사이트에 접속하는데 필요한 시간이 증가한다.

 

 

**라운드 로빈 DNS는 가용성을 제공하지 않기 때문에, 무중단 서비스가 필요한 시스템에는 어울리지 않는다.**

**단순히 여러 대의 웹 서버로 트래픽을 부하 분산할 때 가장 편리하게 사용할 수 있는 옵션이다.**

**가용성이 필요한 시스템의 경우, Health Check기능이 포함된 DNS 서비스를 사용하는 것이 좋다.**

**AWS Route53, Dyn DNS 서비스가 좋은 예다.**

 

 

#### 단점 보완

- GSLB(Global Server Load Balancing) DNS 서비스를 사용하여 도메인 조회 시, 로드 밸런싱과 동시에 Health check 기능을 사용한 HA구성이 모두 가능하도록 구성하는 것 또한 안전한 방법이다.
- 로드벨런서 또한 SPOF(Single Point Of Faliure)가 될 수 있으므로, 2 대 이상의 로드밸런서와 각각의 공인 IP를 준비하고, GSLB로 트래픽을 로드밸런서에 나누는 방법도 많이 사용한다.
- 로그인 세션 등 세션의 유지 서버-클라이언트 간에 필요한 경우, 접속 중이던 클라이언트가 DNS에 의해 다른 서버IP를 할당받아 다른 서버에 접속이 되면 기존 세션이 끊어질 수 있다.
  - 이런 경우 웹 서버끼리 세션을 공유할 수 있도록 세션 클러스터링 설정을 하거나, 로드 밸런서에서 IP나 Cookie 값을 사용하여 동일한 서버로 접속되도록 stickness 설정을 해야 하는데, 이 부분은 L7 스위치로 해결할 수 있다.

 

**라운드 로빈 상식 기반 단점을 해소하는 DNS 스케줄링 알고리즘(일부)**

- Weighted round robin (WRR)
  - 각각의 웹 서버에 가중치를 가미해서 분산 비율을 변경한다. 물론 가중치가 큰 서버일수록 빈번하게 선택되므로 처리능력이 높은 서버는 가중치를 높게 설정하는 것이 좋다.
- Least connection
  - 접속 클라이언트 수가 가장 적은 서버를 선택한다. 로드밸런서에서 실시간으로 connection 수를 관리하거나 각 서버에서 주기적으로 알려주는 것이 필요하다.

 